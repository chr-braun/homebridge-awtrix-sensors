<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWTRIX Integrated GUI</title>
    <style>
        /* AWTRIX Integrated GUI Styles */
        .awtrix-integrated-gui {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .gui-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .gui-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .gui-header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .gui-header p {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .status-indicator {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-indicator i {
            font-size: 1.2em;
        }

        .status-indicator.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid rgba(76, 175, 80, 0.5);
        }

        .status-indicator.disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid rgba(244, 67, 54, 0.5);
        }

        .gui-content {
            padding: 40px;
        }

        .gui-tabs {
            display: flex;
            border-bottom: 3px solid #f0f0f0;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .gui-tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }

        .gui-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .gui-tab:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .gui-tab.active:hover {
            background: #5a6fd8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .sensor-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .sensor-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .sensor-type {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
        }

        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 15px 0;
        }

        .sensor-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 20px 25px;
            border-radius: 10px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #4CAF50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: " ‚è≥";
        }

        /* Scanner specific styles */
        .status-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }

        .status-scanning { 
            background: #ffa500; 
            animation: pulse 1s infinite; 
        }
        .status-idle { background: #6c757d; }
        .status-complete { background: #28a745; }
        .status-error { background: #dc3545; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .quality-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .quality-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .quality-excellent { background: #28a745; }
        .quality-good { background: #17a2b8; }
        .quality-fair { background: #ffc107; }
        .quality-poor { background: #dc3545; }

        .filter-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .no-data i {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .gui-header h1 {
                font-size: 2em;
            }
            
            .status-indicators {
                flex-direction: column;
                align-items: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .sensors-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="awtrix-integrated-gui">
        <div class="gui-container">
            <div class="gui-header">
                <h1>üéØ AWTRIX Integrated GUI</h1>
                <p>Vollst√§ndige AWTRIX-Konfiguration und -Verwaltung</p>
                
                <div class="status-indicators">
                    <div class="status-indicator" id="mqtt-status">
                        <i class="fas fa-wifi"></i>
                        <span>MQTT: Bereit</span>
                    </div>
                    <div class="status-indicator" id="awtrix-status">
                        <i class="fas fa-desktop"></i>
                        <span>AWTRIX: Bereit</span>
                    </div>
                    <div class="status-indicator" id="sensors-status">
                        <i class="fas fa-thermometer-half"></i>
                        <span>Sensoren: 0</span>
                    </div>
                </div>
            </div>

            <div class="gui-content">
                <div class="gui-tabs">
                    <button class="gui-tab active" onclick="switchTab('config')">
                        <i class="fas fa-cog"></i> Konfiguration
                    </button>
                    <button class="gui-tab" onclick="switchTab('sensors')">
                        <i class="fas fa-thermometer-half"></i> Sensoren
                    </button>
                    <button class="gui-tab" onclick="switchTab('awtrix')">
                        <i class="fas fa-desktop"></i> AWTRIX
                    </button>
                    <button class="gui-tab" onclick="switchTab('rules')">
                        <i class="fas fa-robot"></i> Regeln
                    </button>
                    <button class="gui-tab" onclick="switchTab('scanner')">
                        <i class="fas fa-search"></i> Scanner
                    </button>
                    <button class="gui-tab" onclick="switchTab('rules')">
                        <i class="fas fa-robot"></i> Regeln
                    </button>
                    <button class="gui-tab" onclick="switchTab('test')">
                        <i class="fas fa-flask"></i> Tests
                    </button>
                </div>

                <!-- Configuration Tab -->
                <div id="config-tab" class="tab-content active">
                    <div class="section">
                        <h3>üîß MQTT Server Konfiguration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="mqtt-host">Host Address</label>
                                <input type="text" id="mqtt-host" value="192.168.178.29" placeholder="192.168.178.29">
                            </div>
                            <div class="form-group">
                                <label for="mqtt-port">Port</label>
                                <input type="number" id="mqtt-port" value="1883" placeholder="1883">
                            </div>
                            <div class="form-group">
                                <label for="mqtt-username">Benutzername</label>
                                <input type="text" id="mqtt-username" value="biber" placeholder="biber">
                            </div>
                            <div class="form-group">
                                <label for="mqtt-password">Passwort</label>
                                <input type="password" id="mqtt-password" value="2203801826" placeholder="2203801826">
                            </div>
                        </div>
                        <button class="btn" onclick="testMqtt()">
                            <i class="fas fa-wifi"></i> MQTT Testen
                        </button>
                    </div>

                    <div class="section">
                        <h3>üì± AWTRIX Ger√§te Konfiguration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="awtrix-ip">AWTRIX IP-Adresse</label>
                                <input type="text" id="awtrix-ip" value="192.168.178.151" placeholder="192.168.178.151">
                            </div>
                            <div class="form-group">
                                <label for="awtrix-port">AWTRIX Port</label>
                                <input type="number" id="awtrix-port" value="80" placeholder="80">
                            </div>
                        </div>
                        <button class="btn" onclick="discoverAwtrix()">
                            <i class="fas fa-search"></i> AWTRIX Suchen
                        </button>
                    </div>
                </div>

                <!-- Sensors Tab -->
                <div id="sensors-tab" class="tab-content">
                    <div class="section">
                        <h3>üìä Sensor Management</h3>
                        <button class="btn" onclick="scanSensors()">
                            <i class="fas fa-search"></i> Sensoren Scannen
                        </button>
                        <button class="btn btn-success" onclick="addSensor()">
                            <i class="fas fa-plus"></i> Sensor Hinzuf√ºgen
                        </button>
                        <button class="btn btn-warning" onclick="clearSensors()">
                            <i class="fas fa-trash"></i> Alle L√∂schen
                        </button>
                    </div>
                    <div id="sensors-grid" class="sensors-grid">
                        <!-- Sensoren werden hier angezeigt -->
                    </div>
                </div>

                <!-- AWTRIX Tab -->
                <div id="awtrix-tab" class="tab-content">
                    <div class="section">
                        <h3>üì± AWTRIX Ger√§te</h3>
                        <button class="btn" onclick="discoverAwtrix()">
                            <i class="fas fa-search"></i> Ger√§te Suchen
                        </button>
                        <button class="btn btn-success" onclick="testAwtrix()">
                            <i class="fas fa-paper-plane"></i> Test-Nachricht
                        </button>
                    </div>
                    <div id="awtrix-devices" class="sensors-grid">
                        <!-- AWTRIX-Ger√§te werden hier angezeigt -->
                    </div>
                </div>

                <!-- Rules Tab -->
                <div id="rules-tab" class="tab-content">
                    <div class="section">
                        <h3>ü§ñ Intelligente Regel-Engine</h3>
                        <p>Konvertieren Sie MQTT-Sensoren automatisch in intelligente Regeln</p>
                        
                        <div class="button-group">
                            <button class="btn btn-success" onclick="openRuleBuilder()">
                                <i class="fas fa-plus"></i> Regel erstellen
                            </button>
                            <button class="btn btn-secondary" onclick="loadRuleTemplates()">
                                <i class="fas fa-file-alt"></i> Templates
                            </button>
                            <button class="btn btn-warning" onclick="testAllRules()">
                                <i class="fas fa-flask"></i> Alle testen
                            </button>
                            <button class="btn" onclick="refreshRules()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìä Regel-Statistiken</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalRulesCount">0</div>
                                <div class="stat-label">Gesamt-Regeln</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeRulesCount">0</div>
                                <div class="stat-label">Aktive Regeln</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalTriggersCount">0</div>
                                <div class="stat-label">Ausl√∂sungen</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="ruleSensorsCount">0</div>
                                <div class="stat-label">Sensoren</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìã Aktive Regeln</h3>
                        <div id="rulesList" class="sensors-grid">
                            <div class="no-data">
                                <i class="fas fa-robot"></i>
                                <p>Keine Regeln erstellt. Erstellen Sie Ihre erste Regel!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="scanner-tab" class="tab-content">
                    <div class="section">
                        <h3>üîç MQTT Sensor Scanner</h3>
                        <p>Erweiterte Sensor-Suche und -Konfiguration √ºber MQTT</p>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="scan-duration">Scan-Dauer (Sekunden)</label>
                                <input type="number" id="scan-duration" value="30" min="10" max="300">
                            </div>
                            <div class="form-group">
                                <label for="quality-threshold">Qualit√§ts-Schwellenwert</label>
                                <select id="quality-threshold">
                                    <option value="0.1">Niedrig (0.1)</option>
                                    <option value="0.3" selected>Mittel (0.3)</option>
                                    <option value="0.5">Hoch (0.5)</option>
                                    <option value="0.7">Sehr hoch (0.7)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="topic-patterns">Topic-Patterns</label>
                                <select id="topic-patterns">
                                    <option value="common">Standard</option>
                                    <option value="homeassistant">Home Assistant</option>
                                    <option value="tasmota">Tasmota</option>
                                    <option value="esphome">ESPHome</option>
                                    <option value="custom">Benutzerdefiniert</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-success" onclick="startSensorScan()">
                                <i class="fas fa-play"></i> Scan Starten
                            </button>
                            <button class="btn btn-warning" onclick="stopSensorScan()">
                                <i class="fas fa-stop"></i> Scan Stoppen
                            </button>
                            <button class="btn" onclick="refreshScannerResults()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                        
                        <div id="scan-status" class="status-display">
                            <div class="status-item">
                                <span class="status-indicator" id="scan-status-indicator"></span>
                                <strong>Status:</strong> <span id="scan-status-text">Bereit zum Scannen</span>
                            </div>
                            <div class="status-item">
                                <strong>Gefundene Sensoren:</strong> <span id="scanned-sensor-count">0</span>
                            </div>
                            <div class="status-item">
                                <strong>Verbleibende Zeit:</strong> <span id="scan-remaining-time">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìä Scan-Ergebnisse</h3>
                        <div class="filter-controls">
                            <div class="form-group">
                                <label for="scanner-type-filter">Sensortyp</label>
                                <select id="scanner-type-filter" onchange="filterScannedSensors()">
                                    <option value="">Alle Typen</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="scanner-quality-filter">Qualit√§t</label>
                                <select id="scanner-quality-filter" onchange="filterScannedSensors()">
                                    <option value="">Alle Qualit√§ten</option>
                                    <option value="excellent">Ausgezeichnet</option>
                                    <option value="good">Gut</option>
                                    <option value="fair">Mittel</option>
                                    <option value="poor">Schlecht</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="scanner-search-filter">Suche</label>
                                <input type="text" id="scanner-search-filter" placeholder="Sensor-Name oder Topic..." onkeyup="filterScannedSensors()">
                            </div>
                        </div>
                        
                        <div id="scanned-sensors-grid" class="sensors-grid">
                            <div class="no-data">
                                <i class="fas fa-search"></i>
                                <p>Keine Sensoren gefunden. Starten Sie einen Scan.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Tab -->
                <div id="test-tab" class="tab-content">
                    <div class="section">
                        <h3>üß™ Test Suite</h3>
                        <p>F√ºhren Sie umfassende Tests aller AWTRIX-Funktionen durch.</p>
                        <button class="btn btn-success" onclick="runAllTests()">
                            <i class="fas fa-play"></i> Alle Tests Ausf√ºhren
                        </button>
                        <button class="btn" onclick="testMqtt()">
                            <i class="fas fa-wifi"></i> MQTT Test
                        </button>
                        <button class="btn" onclick="testAwtrix()">
                            <i class="fas fa-desktop"></i> AWTRIX Test
                        </button>
                        <button class="btn" onclick="scanSensors()">
                            <i class="fas fa-thermometer-half"></i> Sensor Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        // AWTRIX Integrated GUI JavaScript
        class AwtrixIntegratedGUI {
            constructor() {
                this.sensors = [];
                this.awtrixDevices = [];
                this.rules = [];
                this.scannedSensors = [];
                this.isScanning = false;
                this.scanTimer = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadConfiguration();
                this.showToast('AWTRIX Integrated GUI geladen!', 'success');
            }

            setupEventListeners() {
                // Tab switching is handled by onclick attributes
            }

            loadConfiguration() {
                // Load saved configuration
                const saved = localStorage.getItem('awtrix-config');
                if (saved) {
                    const config = JSON.parse(saved);
                    if (config.mqtt) {
                        document.getElementById('mqtt-host').value = config.mqtt.host || '192.168.178.29';
                        document.getElementById('mqtt-port').value = config.mqtt.port || 1883;
                        document.getElementById('mqtt-username').value = config.mqtt.username || 'biber';
                        document.getElementById('mqtt-password').value = config.mqtt.password || '2203801826';
                    }
                    if (config.awtrix) {
                        document.getElementById('awtrix-ip').value = config.awtrix.ip || '192.168.178.151';
                        document.getElementById('awtrix-port').value = config.awtrix.port || 80;
                    }
                    this.sensors = config.sensors || [];
                    this.displaySensors();
                }
            }

            saveConfiguration() {
                const config = {
                    mqtt: {
                        host: document.getElementById('mqtt-host').value,
                        port: parseInt(document.getElementById('mqtt-port').value),
                        username: document.getElementById('mqtt-username').value,
                        password: document.getElementById('mqtt-password').value
                    },
                    awtrix: {
                        ip: document.getElementById('awtrix-ip').value,
                        port: parseInt(document.getElementById('awtrix-port').value)
                    },
                    sensors: this.sensors
                };
                localStorage.setItem('awtrix-config', JSON.stringify(config));
                this.showToast('Konfiguration gespeichert!', 'success');
            }

            async testMqtt() {
                this.setLoading(event.target, true);
                this.updateStatus('mqtt-status', 'Teste MQTT...', 'info');

                try {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    this.updateStatus('mqtt-status', 'MQTT Verbunden!', 'connected');
                    this.showToast('MQTT-Verbindung erfolgreich!', 'success');
                } catch (error) {
                    this.updateStatus('mqtt-status', 'MQTT Fehler', 'disconnected');
                    this.showToast('MQTT-Verbindung fehlgeschlagen!', 'error');
                } finally {
                    this.setLoading(event.target, false);
                }
            }

            async discoverAwtrix() {
                this.setLoading(event.target, true);
                this.updateStatus('awtrix-status', 'Suche AWTRIX...', 'info');

                try {
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    this.awtrixDevices = [
                        { name: 'AWTRIX Living Room', ip: '192.168.178.151', online: true, version: '2.0.0' }
                    ];
                    this.displayAwtrixDevices();
                    this.updateStatus('awtrix-status', '1 Ger√§t gefunden!', 'connected');
                    this.showToast('AWTRIX-Ger√§t gefunden!', 'success');
                } catch (error) {
                    this.updateStatus('awtrix-status', 'AWTRIX Fehler', 'disconnected');
                    this.showToast('AWTRIX-Suche fehlgeschlagen!', 'error');
                } finally {
                    this.setLoading(event.target, false);
                }
            }

            async testAwtrix() {
                this.setLoading(event.target, true);

                try {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    this.showToast('Test-Nachricht an AWTRIX gesendet!', 'success');
                } catch (error) {
                    this.showToast('AWTRIX-Test fehlgeschlagen!', 'error');
                } finally {
                    this.setLoading(event.target, false);
                }
            }

            async scanSensors() {
                this.setLoading(event.target, true);

                try {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    this.sensors = [
                        { id: 'temp1', name: 'Wohnzimmer Temperatur', type: 'temperature', value: '22.5¬∞C', priority: 'high', enabled: true },
                        { id: 'hum1', name: 'Schlafzimmer Luftfeuchtigkeit', type: 'humidity', value: '45%', priority: 'medium', enabled: true },
                        { id: 'motion1', name: 'Eingang Bewegung', type: 'motion', value: 'Nein', priority: 'high', enabled: true },
                        { id: 'light1', name: 'Au√üenlicht', type: 'light', value: '850 lux', priority: 'low', enabled: true }
                    ];
                    this.displaySensors();
                    this.updateStatus('sensors-status', `${this.sensors.length} Sensoren`, 'connected');
                    this.showToast(`${this.sensors.length} Sensoren gefunden!`, 'success');
                } catch (error) {
                    this.showToast('Sensor-Scan fehlgeschlagen!', 'error');
                } finally {
                    this.setLoading(event.target, false);
                }
            }

            displaySensors() {
                const container = document.getElementById('sensors-grid');
                container.innerHTML = '';

                if (this.sensors.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">Keine Sensoren. Klicken Sie "Sensoren Scannen" um welche zu finden.</p>';
                    return;
                }

                this.sensors.forEach(sensor => {
                    const card = document.createElement('div');
                    card.className = 'sensor-card';
                    card.innerHTML = `
                        <h4>${sensor.name}</h4>
                        <span class="sensor-type">${sensor.type}</span>
                        <div class="sensor-value">${sensor.value}</div>
                        <div class="sensor-actions">
                            <button class="btn" onclick="gui.toggleSensor('${sensor.id}')">
                                <i class="fas fa-power-off"></i> ${sensor.enabled ? 'Deaktivieren' : 'Aktivieren'}
                            </button>
                            <button class="btn btn-danger" onclick="gui.removeSensor('${sensor.id}')">
                                <i class="fas fa-trash"></i> L√∂schen
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            displayAwtrixDevices() {
                const container = document.getElementById('awtrix-devices');
                container.innerHTML = '';

                this.awtrixDevices.forEach(device => {
                    const card = document.createElement('div');
                    card.className = 'sensor-card';
                    card.innerHTML = `
                        <h4>${device.name}</h4>
                        <span class="sensor-type">AWTRIX Device</span>
                        <div class="sensor-value">${device.ip}</div>
                        <div class="sensor-actions">
                            <button class="btn" onclick="gui.testAwtrix()">
                                <i class="fas fa-paper-plane"></i> Test
                            </button>
                            <button class="btn btn-success" onclick="gui.configureDevice('${device.ip}')">
                                <i class="fas fa-cog"></i> Konfigurieren
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            addSensor() {
                const sensor = {
                    id: 'sensor_' + Date.now(),
                    name: 'Neuer Sensor',
                    type: 'temperature',
                    value: '0¬∞C',
                    priority: 'medium',
                    enabled: true
                };
                this.sensors.push(sensor);
                this.displaySensors();
                this.showToast('Sensor hinzugef√ºgt!', 'success');
            }

            toggleSensor(id) {
                const sensor = this.sensors.find(s => s.id === id);
                if (sensor) {
                    sensor.enabled = !sensor.enabled;
                    this.displaySensors();
                    this.showToast(`Sensor ${sensor.enabled ? 'aktiviert' : 'deaktiviert'}!`, 'info');
                }
            }

            removeSensor(id) {
                this.sensors = this.sensors.filter(s => s.id !== id);
                this.displaySensors();
                this.showToast('Sensor entfernt!', 'info');
            }

            clearSensors() {
                if (confirm('Alle Sensoren l√∂schen?')) {
                    this.sensors = [];
                    this.displaySensors();
                    this.updateStatus('sensors-status', '0 Sensoren', 'disconnected');
                    this.showToast('Alle Sensoren gel√∂scht!', 'info');
                }
            }

            createRule() {
                this.showToast('Regel-Erstellung wird implementiert...', 'info');
            }

            testRules() {
                this.showToast('Regel-Tests werden implementiert...', 'info');
            }

            async runAllTests() {
                this.showToast('Starte alle Tests...', 'info');
                await this.testMqtt();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await this.discoverAwtrix();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await this.testAwtrix();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await this.scanSensors();
                this.showToast('Alle Tests abgeschlossen!', 'success');
            }

            setLoading(button, loading) {
                if (loading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }

            updateStatus(elementId, text, type) {
                const element = document.getElementById(elementId);
                const span = element.querySelector('span');
                span.textContent = text;
                element.className = `status-indicator ${type}`;
            }

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }

            // Scanner Functions
            async startSensorScan() {
                if (this.isScanning) return;

                const scanDuration = parseInt(document.getElementById('scan-duration').value);
                const qualityThreshold = parseFloat(document.getElementById('quality-threshold').value);

                this.isScanning = true;
                this.updateScanStatus('scanning', 0, scanDuration);

                try {
                    // Simulate scan (in real implementation, this would call the actual API)
                    const results = await this.simulateSensorScan(scanDuration, qualityThreshold);
                    
                    this.scannedSensors = results;
                    this.updateScanStatus('complete', results.length, 0);
                    this.displayScannedSensors();
                    this.updateScannerTypeFilter();
                    
                    this.showToast(`Scan abgeschlossen! ${results.length} Sensoren gefunden.`, 'success');
                    
                } catch (error) {
                    this.updateScanStatus('error', 0, 0);
                    this.showToast('Scan fehlgeschlagen: ' + error.message, 'error');
                } finally {
                    this.isScanning = false;
                }
            }

            async stopSensorScan() {
                if (!this.isScanning) return;

                this.isScanning = false;
                this.updateScanStatus('idle', this.scannedSensors.length, 0);
                this.showToast('Scan gestoppt', 'warning');
            }

            async simulateSensorScan(duration, qualityThreshold) {
                // Simulate scanning with realistic sensor data
                const sensorTypes = ['temperature', 'humidity', 'pressure', 'motion', 'light', 'voltage', 'current', 'power'];
                const devices = ['living_room', 'bedroom', 'kitchen', 'bathroom', 'garage', 'garden', 'office'];
                const manufacturers = ['Home Assistant', 'Tasmota', 'ESPHome', 'Zigbee2MQTT', 'OpenHAB'];
                
                const results = [];
                const numSensors = Math.floor(Math.random() * 15) + 5; // 5-20 sensors
                
                for (let i = 0; i < numSensors; i++) {
                    const type = sensorTypes[Math.floor(Math.random() * sensorTypes.length)];
                    const device = devices[Math.floor(Math.random() * devices.length)];
                    const manufacturer = manufacturers[Math.floor(Math.random() * manufacturers.length)];
                    
                    const quality = Math.random();
                    if (quality < qualityThreshold) continue;
                    
                    const sensor = {
                        topic: `sensors/${device}/${type}`,
                        name: `${device.replace('_', ' ')} ${type}`,
                        type: type,
                        value: this.generateSensorValue(type),
                        unit: this.getSensorUnit(type),
                        timestamp: new Date(),
                        quality: quality,
                        metadata: {
                            deviceId: device,
                            location: device.replace('_', ' '),
                            manufacturer: manufacturer
                        }
                    };
                    
                    results.push(sensor);
                }
                
                // Simulate scan duration
                await new Promise(resolve => setTimeout(resolve, Math.min(duration * 100, 2000)));
                
                return results.sort((a, b) => b.quality - a.quality);
            }

            generateSensorValue(type) {
                switch (type) {
                    case 'temperature': return (Math.random() * 30 + 10).toFixed(1);
                    case 'humidity': return Math.floor(Math.random() * 100);
                    case 'pressure': return (Math.random() * 200 + 900).toFixed(1);
                    case 'motion': return Math.random() > 0.5 ? 'Bewegung' : 'Keine Bewegung';
                    case 'light': return Math.floor(Math.random() * 1000);
                    case 'voltage': return (Math.random() * 5 + 220).toFixed(1);
                    case 'current': return (Math.random() * 10).toFixed(2);
                    case 'power': return Math.floor(Math.random() * 1000);
                    default: return Math.floor(Math.random() * 100);
                }
            }

            getSensorUnit(type) {
                switch (type) {
                    case 'temperature': return '¬∞C';
                    case 'humidity': return '%';
                    case 'pressure': return 'hPa';
                    case 'motion': return '';
                    case 'light': return 'lux';
                    case 'voltage': return 'V';
                    case 'current': return 'A';
                    case 'power': return 'W';
                    default: return '';
                }
            }

            updateScanStatus(status, sensorCount, remainingTime) {
                const statusIndicator = document.getElementById('scan-status-indicator');
                const statusText = document.getElementById('scan-status-text');
                const sensorCountElement = document.getElementById('scanned-sensor-count');
                const remainingTimeElement = document.getElementById('scan-remaining-time');
                
                if (statusIndicator) statusIndicator.className = `status-indicator status-${status}`;
                if (statusText) {
                    let statusTextValue = '';
                    switch (status) {
                        case 'scanning': statusTextValue = 'Scan l√§uft...'; break;
                        case 'complete': statusTextValue = 'Scan abgeschlossen'; break;
                        case 'error': statusTextValue = 'Scan fehlgeschlagen'; break;
                        default: statusTextValue = 'Bereit zum Scannen'; break;
                    }
                    statusText.textContent = statusTextValue;
                }
                if (sensorCountElement) sensorCountElement.textContent = sensorCount;
                if (remainingTimeElement) remainingTimeElement.textContent = remainingTime > 0 ? `${remainingTime}s` : '-';
            }

            displayScannedSensors() {
                const container = document.getElementById('scanned-sensors-grid');
                if (!container) return;
                
                if (this.scannedSensors.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-search"></i>
                            <p>Keine Sensoren gefunden. Starten Sie einen Scan.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.scannedSensors.map(sensor => `
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <h4>${sensor.name}</h4>
                            <span class="sensor-type">${sensor.type}</span>
                        </div>
                        
                        <div class="sensor-value">
                            ${sensor.value} ${sensor.unit || ''}
                        </div>
                        
                        <div class="sensor-details">
                            <div><strong>Topic:</strong> ${sensor.topic}</div>
                            <div><strong>Hersteller:</strong> ${sensor.metadata?.manufacturer || 'Unbekannt'}</div>
                            <div><strong>Standort:</strong> ${sensor.metadata?.location || 'Unbekannt'}</div>
                            <div><strong>Zeitstempel:</strong> ${sensor.timestamp.toLocaleString('de-DE')}</div>
                        </div>
                        
                        <div class="quality-bar">
                            <div class="quality-fill ${this.getQualityClass(sensor.quality)}" 
                                 style="width: ${sensor.quality * 100}%"></div>
                        </div>
                        
                        <div class="sensor-actions">
                            <button class="btn btn-success btn-small" onclick="addScannedSensorToConfig('${sensor.topic}')">
                                <i class="fas fa-plus"></i> Hinzuf√ºgen
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="convertSensorToRule('${sensor.topic}')">
                                <i class="fas fa-robot"></i> Regel erstellen
                            </button>
                            <button class="btn btn-small" onclick="viewScannedSensorDetails('${sensor.topic}')">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getQualityClass(quality) {
                if (quality >= 0.8) return 'quality-excellent';
                if (quality >= 0.6) return 'quality-good';
                if (quality >= 0.4) return 'quality-fair';
                return 'quality-poor';
            }

            updateScannerTypeFilter() {
                const typeFilter = document.getElementById('scanner-type-filter');
                if (!typeFilter) return;
                
                const types = [...new Set(this.scannedSensors.map(s => s.type))].sort();
                
                typeFilter.innerHTML = '<option value="">Alle Typen</option>' +
                    types.map(type => `<option value="${type}">${type}</option>`).join('');
            }

            filterScannedSensors() {
                const typeFilter = document.getElementById('scanner-type-filter')?.value || '';
                const qualityFilter = document.getElementById('scanner-quality-filter')?.value || '';
                const searchFilter = document.getElementById('scanner-search-filter')?.value.toLowerCase() || '';

                let filtered = this.scannedSensors.filter(sensor => {
                    if (typeFilter && sensor.type !== typeFilter) return false;
                    if (qualityFilter && this.getQualityClass(sensor.quality) !== `quality-${qualityFilter}`) return false;
                    if (searchFilter && !sensor.name.toLowerCase().includes(searchFilter) && 
                        !sensor.topic.toLowerCase().includes(searchFilter)) return false;
                    return true;
                });

                // Update display with filtered results
                const container = document.getElementById('scanned-sensors-grid');
                if (!container) return;
                
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-filter"></i>
                            <p>Keine Sensoren entsprechen den Filterkriterien.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(sensor => `
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <h4>${sensor.name}</h4>
                            <span class="sensor-type">${sensor.type}</span>
                        </div>
                        
                        <div class="sensor-value">
                            ${sensor.value} ${sensor.unit || ''}
                        </div>
                        
                        <div class="sensor-details">
                            <div><strong>Topic:</strong> ${sensor.topic}</div>
                            <div><strong>Hersteller:</strong> ${sensor.metadata?.manufacturer || 'Unbekannt'}</div>
                            <div><strong>Standort:</strong> ${sensor.metadata?.location || 'Unbekannt'}</div>
                            <div><strong>Zeitstempel:</strong> ${sensor.timestamp.toLocaleString('de-DE')}</div>
                        </div>
                        
                        <div class="quality-bar">
                            <div class="quality-fill ${this.getQualityClass(sensor.quality)}" 
                                 style="width: ${sensor.quality * 100}%"></div>
                        </div>
                        
                        <div class="sensor-actions">
                            <button class="btn btn-success btn-small" onclick="addScannedSensorToConfig('${sensor.topic}')">
                                <i class="fas fa-plus"></i> Hinzuf√ºgen
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="convertSensorToRule('${sensor.topic}')">
                                <i class="fas fa-robot"></i> Regel erstellen
                            </button>
                            <button class="btn btn-small" onclick="viewScannedSensorDetails('${sensor.topic}')">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            refreshScannerResults() {
                this.displayScannedSensors();
                this.updateScannerTypeFilter();
                this.showToast('Scanner-Ergebnisse aktualisiert', 'info');
            }

            // Rule Engine Functions
            async loadRules() {
                try {
                    // Simulate loading rules
                    this.rules = [
                        {
                            id: 'rule_1',
                            name: 'Wohnzimmer Temperatur Warnung',
                            description: 'Warnt bei hoher Temperatur im Wohnzimmer',
                            sensorTopic: 'sensors/living_room/temperature',
                            sensorName: 'Wohnzimmer Temperatur',
                            sensorType: 'temperature',
                            enabled: true,
                            priority: 5,
                            triggerCount: 12,
                            lastTriggered: new Date()
                        },
                        {
                            id: 'rule_2',
                            name: 'Schlafzimmer Luftfeuchtigkeit',
                            description: 'Zeigt Luftfeuchtigkeit im Schlafzimmer an',
                            sensorTopic: 'sensors/bedroom/humidity',
                            sensorName: 'Schlafzimmer Luftfeuchtigkeit',
                            sensorType: 'humidity',
                            enabled: true,
                            priority: 3,
                            triggerCount: 45,
                            lastTriggered: new Date()
                        }
                    ];

                    this.displayRules();
                    this.updateRuleStatistics();
                } catch (error) {
                    this.showToast('Fehler beim Laden der Regeln: ' + error.message, 'error');
                }
            }

            displayRules() {
                const container = document.getElementById('rulesList');
                if (!container) return;
                
                if (this.rules.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-robot"></i>
                            <p>Keine Regeln erstellt. Erstellen Sie Ihre erste Regel!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.rules.map(rule => `
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <h4>${rule.name}</h4>
                            <span class="sensor-type ${rule.enabled ? 'enabled' : 'disabled'}">
                                ${rule.enabled ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </div>
                        
                        <div class="sensor-value">
                            ${rule.triggerCount} Ausl√∂sungen
                        </div>
                        
                        <div class="sensor-details">
                            <div><strong>Sensor:</strong> ${rule.sensorName}</div>
                            <div><strong>Typ:</strong> ${rule.sensorType}</div>
                            <div><strong>Priorit√§t:</strong> ${rule.priority}</div>
                            <div><strong>Letzte Ausl√∂sung:</strong> ${rule.lastTriggered ? rule.lastTriggered.toLocaleString('de-DE') : 'Nie'}</div>
                        </div>
                        
                        <div class="sensor-actions">
                            <button class="btn btn-success btn-small" onclick="gui.editRule('${rule.id}')">
                                <i class="fas fa-edit"></i> Bearbeiten
                            </button>
                            <button class="btn ${rule.enabled ? 'btn-warning' : 'btn-secondary'} btn-small" onclick="gui.toggleRule('${rule.id}')">
                                <i class="fas fa-${rule.enabled ? 'pause' : 'play'}"></i> ${rule.enabled ? 'Deaktivieren' : 'Aktivieren'}
                            </button>
                            <button class="btn btn-danger btn-small" onclick="gui.deleteRule('${rule.id}')">
                                <i class="fas fa-trash"></i> L√∂schen
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            updateRuleStatistics() {
                const totalRules = this.rules.length;
                const activeRules = this.rules.filter(r => r.enabled).length;
                const totalTriggers = this.rules.reduce((sum, r) => sum + r.triggerCount, 0);
                const ruleSensors = new Set(this.rules.map(r => r.sensorTopic)).size;

                document.getElementById('totalRulesCount').textContent = totalRules;
                document.getElementById('activeRulesCount').textContent = activeRules;
                document.getElementById('totalTriggersCount').textContent = totalTriggers;
                document.getElementById('ruleSensorsCount').textContent = ruleSensors;
            }

            openRuleBuilder() {
                // Open rule builder in new window
                window.open('rule-builder-gui.html', 'ruleBuilder', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            }

            loadRuleTemplates() {
                this.showToast('Lade Regel-Templates...', 'info');
                // In real implementation, this would load templates from the API
            }

            testAllRules() {
                this.showToast('Teste alle Regeln...', 'info');
                // In real implementation, this would test all rules
            }

            refreshRules() {
                this.loadRules();
                this.showToast('Regeln aktualisiert', 'info');
            }

            editRule(ruleId) {
                const rule = this.rules.find(r => r.id === ruleId);
                if (rule) {
                    this.showToast(`Bearbeite Regel: ${rule.name}`, 'info');
                    // In real implementation, this would open an edit dialog
                }
            }

            toggleRule(ruleId) {
                const rule = this.rules.find(r => r.id === ruleId);
                if (rule) {
                    rule.enabled = !rule.enabled;
                    this.displayRules();
                    this.updateRuleStatistics();
                    this.showToast(`Regel ${rule.enabled ? 'aktiviert' : 'deaktiviert'}: ${rule.name}`, 'success');
                }
            }

            deleteRule(ruleId) {
                if (confirm('M√∂chten Sie diese Regel wirklich l√∂schen?')) {
                    this.rules = this.rules.filter(r => r.id !== ruleId);
                    this.displayRules();
                    this.updateRuleStatistics();
                    this.showToast('Regel gel√∂scht', 'info');
                }
            }

            // Method to convert scanned sensor to rule
            convertSensorToRule(sensorTopic, templateId) {
                const sensor = this.scannedSensors.find(s => s.topic === sensorTopic);
                if (!sensor) {
                    this.showToast('Sensor nicht gefunden', 'error');
                    return;
                }

                // Create rule from sensor
                const rule = {
                    id: `rule_${Date.now()}`,
                    name: `Auto Rule - ${sensor.name}`,
                    description: `Automatisch erstellte Regel f√ºr ${sensor.name}`,
                    sensorTopic: sensor.topic,
                    sensorName: sensor.name,
                    sensorType: sensor.type,
                    enabled: true,
                    priority: 5,
                    triggerCount: 0,
                    lastTriggered: null
                };

                this.rules.push(rule);
                this.displayRules();
                this.updateRuleStatistics();
                this.showToast(`Regel erstellt f√ºr: ${sensor.name}`, 'success');
            }
        }

        // Global functions for tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.gui-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Global functions for buttons
        function testMqtt() { gui.testMqtt(); }
        function discoverAwtrix() { gui.discoverAwtrix(); }
        function testAwtrix() { gui.testAwtrix(); }
        function scanSensors() { gui.scanSensors(); }
        function addSensor() { gui.addSensor(); }
        function clearSensors() { gui.clearSensors(); }
        function createRule() { gui.createRule(); }
        function testRules() { gui.testRules(); }
        function runAllTests() { gui.runAllTests(); }
        
        // Scanner functions
        function startSensorScan() { gui.startSensorScan(); }
        function stopSensorScan() { gui.stopSensorScan(); }
        function refreshScannerResults() { gui.refreshScannerResults(); }
        function filterScannedSensors() { gui.filterScannedSensors(); }
        function addScannedSensorToConfig(topic) { 
            const sensor = gui.scannedSensors.find(s => s.topic === topic);
            if (sensor) {
                gui.showToast(`Sensor "${sensor.name}" wurde zur Konfiguration hinzugef√ºgt!`, 'success');
                // In real implementation, this would call the API to add the sensor
            }
        }
        function viewScannedSensorDetails(topic) { 
            const sensor = gui.scannedSensors.find(s => s.topic === topic);
            if (sensor) {
                alert(`Sensor-Details:\n\nName: ${sensor.name}\nTyp: ${sensor.type}\nWert: ${sensor.value} ${sensor.unit || ''}\nTopic: ${sensor.topic}\nQualit√§t: ${(sensor.quality * 100).toFixed(1)}%\nHersteller: ${sensor.metadata?.manufacturer || 'Unbekannt'}\nStandort: ${sensor.metadata?.location || 'Unbekannt'}`);
            }
        }
        
        // Rule Engine functions
        function openRuleBuilder() { gui.openRuleBuilder(); }
        function loadRuleTemplates() { gui.loadRuleTemplates(); }
        function testAllRules() { gui.testAllRules(); }
        function refreshRules() { gui.refreshRules(); }
        function editRule(ruleId) { gui.editRule(ruleId); }
        function toggleRule(ruleId) { gui.toggleRule(ruleId); }
        function deleteRule(ruleId) { gui.deleteRule(ruleId); }
        function convertSensorToRule(sensorTopic, templateId) { gui.convertSensorToRule(sensorTopic, templateId); }

        // Initialize GUI
        let gui;
        document.addEventListener('DOMContentLoaded', () => {
            gui = new AwtrixIntegratedGUI();
        });
    </script>
</body>
</html>
